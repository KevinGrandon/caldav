#! /usr/bin/env node

var CalDav = require('../lib/caldav');
var configurations = JSON.parse(require('fs').readFileSync(
  __dirname + '/test-configs.json', 'utf8'
));

var connectionType = process.argv[2];

if (!connectionType || !(connectionType in configurations)) {
  console.error(
    'You must choose an available configuration:',
    Object.keys(configurations)
  );
  process.exit(1);
}

var config = configurations[connectionType];

var con = new CalDav.Connection({
  domain: config.domain,
  user: config.user,
  password: config.password
});

var Propfind = CalDav.Request.Propfind;

function findProp(uri) {
  return new Propfind(con, {
    url: uri || config.uri
  });
}

// Have some url determine where the principal is
var findCal = findProp();
findCal.prop('current-user-principal');
findCal.prop('resourcetype');
findCal.prop('principal-URL');

function getProp(propName, obj, single) {
  var key, url, level, results = {};

  for (url in obj) {
    level = obj[url];
    for (key in level) {
      if (key === propName && level[key].status) {
        results[url] = level[key].value;
        if (single) {
          return results[url];
        }
      }
    }
  }

  return results;
}

findCal.send(function(err, data) {

  // found principal find calendar home
  var principaluri = getProp('current-user-principal', data, true);
  console.log('PRINCIPAL:', principaluri);
  var principalFind = findProp(principaluri);

  principalFind.prop('resourcetype');
  principalFind.prop(['caldav', 'calendar-home-set']);

  principalFind.send(function(err, data) {
    var caluri = getProp('calendar-home-set', data, true);
    var calFind = findProp(caluri);
    console.log('CALENDAR_HOME:', caluri);
    calFind.prop(['ical', 'calendar-color']);
    calFind.prop('owner');
    calFind.prop('displayname');
    calFind.prop('resourcetype');
    calFind.prop(['calserver', 'getctag']);
    calFind.depth = 1;


    // found calendar home find calendars.
    calFind.send(function(err, data) {
      var url, name;

      for (url in data) {
        if (data[url].resourcetype.value.indexOf('calendar') !== -1) {
          name = data[url].displayname.value.value;
          console.log('CAL RESOURCE:', name, '-', url);
        }
      }
      console.log('DATA:');
      console.log(JSON.stringify(data));
    });
  });

});
